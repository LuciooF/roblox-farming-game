name: Deploy to Roblox

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install Rojo directly
      run: |
        # Install Rojo directly from GitHub releases
        wget https://github.com/rojo-rbx/rojo/releases/download/v7.4.4/rojo-7.4.4-linux-x86_64.zip
        unzip rojo-7.4.4-linux-x86_64.zip
        chmod +x rojo
        sudo mv rojo /usr/local/bin/
    
    - name: Install Wally directly  
      run: |
        # Install Wally directly from GitHub releases
        wget https://github.com/UpliftGames/wally/releases/download/v0.3.2/wally-0.3.2-linux-x86_64.zip
        unzip wally-0.3.2-linux-x86_64.zip
        chmod +x wally
        sudo mv wally /usr/local/bin/
    
    - name: Install Wally dependencies
      run: |
        # Create wally.toml if it doesn't exist
        if [ ! -f "wally.toml" ]; then
          echo '[package]' > wally.toml
          echo 'name = "lucioof/farming-game"' >> wally.toml
          echo 'version = "1.0.0"' >> wally.toml
          echo 'registry = "https://github.com/UpliftGames/wally-index"' >> wally.toml
          echo 'realm = "shared"' >> wally.toml
          echo '' >> wally.toml
          echo '[dependencies]' >> wally.toml
          echo 'React = "jsdotlua/react@17.1.0"' >> wally.toml
          echo 'ReactRoblox = "jsdotlua/react-roblox@17.1.0"' >> wally.toml
        fi
        wally install
    
    - name: Build place file
      run: |
        # Create default.project.json if it doesn't exist
        if [ ! -f "default.project.json" ]; then
          cat > default.project.json << 'EOF'
        {
          "name": "FarmingGame",
          "tree": {
            "$className": "DataModel",
            "ReplicatedStorage": {
              "$className": "ReplicatedStorage",
              "Packages": {
                "$path": "Packages"
              }
            },
            "ServerScriptService": {
              "$className": "ServerScriptService",
              "Server": {
                "$path": "src/server"
              }
            },
            "StarterPlayerScripts": {
              "$className": "StarterPlayerScripts",
              "Client": {
                "$path": "src/client"
              }
            }
          }
        }
        EOF
        fi
        rojo build --output game.rbxl
    
    - name: Upload to Roblox
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        # Install rbxcloud CLI for uploading
        npm install -g @roblox/rbxcloud-cli
        
        # Upload the place file to Roblox
        rbxcloud experience publish-place \
          --file game.rbxl \
          --experience-id ${{ secrets.ROBLOX_EXPERIENCE_ID }} \
          --place-id ${{ secrets.ROBLOX_PLACE_ID }} \
          --api-key ${{ secrets.ROBLOX_API_KEY }} \
          --version-type Published
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: game-build
        path: game.rbxl
        retention-days: 30